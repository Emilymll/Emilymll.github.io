<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Flask学习笔记 | Emily</title><meta name="author" content="Emily"><meta name="copyright" content="Emily"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="简介Flask 是一个用 Python 编写的轻量级 Web 应用框架。 Flask 基于 WSGI（Web Server Gateway Interface）和 Jinja2 模板引擎，旨在帮助开发者快速、简便地创建 Web 应用。 Flask 被称为”微框架”，因为它使用简单的核心，用扩展增加其他功能。 Flask 是灵活的，提供了基本的框架结构，但没有强制性的项目布局或组件，开发者可以根据自">
<meta property="og:type" content="article">
<meta property="og:title" content="Flask学习笔记">
<meta property="og:url" content="http://example.com/2024/10/28/Flask%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="Emily">
<meta property="og:description" content="简介Flask 是一个用 Python 编写的轻量级 Web 应用框架。 Flask 基于 WSGI（Web Server Gateway Interface）和 Jinja2 模板引擎，旨在帮助开发者快速、简便地创建 Web 应用。 Flask 被称为”微框架”，因为它使用简单的核心，用扩展增加其他功能。 Flask 是灵活的，提供了基本的框架结构，但没有强制性的项目布局或组件，开发者可以根据自">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/avatar.jpg">
<meta property="article:published_time" content="2024-10-27T16:00:00.000Z">
<meta property="article:modified_time" content="2024-10-28T11:20:27.003Z">
<meta property="article:author" content="Emily">
<meta property="article:tag" content="Python">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/avatar.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2024/10/28/Flask%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":230},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Flask学习笔记',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-10-28 19:20:27'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/mogai.css"><link rel="stylesheet" href="/css/font/iconfont.css"><link rel="stylesheet" href="/css/yituliu.css"><meta name="generator" content="Hexo 7.0.0"><link rel="alternate" href="/atom.xml" title="Emily" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">4</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">1</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">1</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon--home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw iconfont icon-exe-article-primary"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw iconfont icon-Link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-geren"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background: transparent"><nav id="nav"><span id="blog-info"><a href="/" title="Emily"></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon--home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw iconfont icon-exe-article-primary"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw iconfont icon-Link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-geren"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Flask学习笔记</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2024-10-27T16:00:00.000Z" title="发表于 2024-10-28 00:00:00">2024-10-28</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Flask学习笔记"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>Flask 是一个用 Python 编写的轻量级 Web 应用框架。</p>
<p>Flask 基于 WSGI（Web Server Gateway Interface）和 Jinja2 模板引擎，旨在帮助开发者快速、简便地创建 Web 应用。</p>
<p>Flask 被称为”微框架”，因为它使用简单的核心，用扩展增加其他功能。</p>
<p>Flask 是灵活的，提供了基本的框架结构，但没有强制性的项目布局或组件，开发者可以根据自己的需求自定义。</p>
<p>Flask 安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install Flask</span><br></pre></td></tr></table></figure>

<p>安装完成后，可以通过以下命令验证 Flask 是否安装成功：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip show Flask</span><br></pre></td></tr></table></figure>

<h1 id="虚拟环境"><a href="#虚拟环境" class="headerlink" title="虚拟环境"></a>虚拟环境</h1><p>虚拟环境是独立于 Python 全局环境的 Python 解释器环境，使用它的好处如下：</p>
<ul>
<li>保持全局环境的干净</li>
<li>为同一个库在不同环境下指定不同的版本</li>
<li>方便记录和管理某个项目相关的依赖</li>
</ul>
<p>在虚拟环境中，pip 版本不会继承全局环境中的版本，也不会继承全局环境中已经安装的包。如果虚拟环境被删除，即删除对应文件夹，则在虚拟环境中执行的所有安装、升级等操作一并被删除，且不会影响全局环境。</p>
<h2 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h2><p>我们将使用 Python 3 内置的 venv 模块创建虚拟环境，使用下面的命令即可为当前项目创建一个虚拟环境：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python -m venv <span class="built_in">env</span>  <span class="comment"># Windows</span></span><br></pre></td></tr></table></figure>

<p>或：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python3 -m venv <span class="built_in">env</span>  <span class="comment"># Linux 和 macOS</span></span><br></pre></td></tr></table></figure>

<p>上述命令的最后一个参数是虚拟环境名称，你可以自由定义，比如 venv、env、.venv，或是“项目名-venv”，这里使用了 env。</p>
<h2 id="激活"><a href="#激活" class="headerlink" title="激活"></a>激活</h2><p>创建虚拟环境后，我们可以使用下面的命令来激活虚拟环境（通过执行 &#x2F;source 目录内的激活脚本实现）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">env</span>\Scripts\activate  <span class="comment"># Windows</span></span><br></pre></td></tr></table></figure>

<p>或：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ . <span class="built_in">env</span>/bin/activate  <span class="comment"># Linux 或 macOS</span></span><br></pre></td></tr></table></figure>

<p>这时命令提示符前会显示虚拟环境的名称，表示已经激活成功：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="built_in">env</span>) $</span><br></pre></td></tr></table></figure>

<p>退出虚拟环境：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="built_in">env</span>) $ deactivate</span><br></pre></td></tr></table></figure>

<h1 id="第一个应用"><a href="#第一个应用" class="headerlink" title="第一个应用"></a>第一个应用</h1><p>创建一个名为 app.py 的文件，并添加以下内容：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello_world</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello, World!&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>在命令行中运行 Flask 应用：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python app.py</span><br></pre></td></tr></table></figure>

<p>打开浏览器，访问 <code>http://127.0.0.1:5000/</code> 即可。</p>
<p>代码解析：</p>
<ul>
<li>**<code>from flask import Flask</code>**： 这行代码从 <code>flask</code> 模块中导入了 <code>Flask</code> 类。<code>Flask</code> 类是 Flask 框架的核心，用于创建 Flask 应用程序实例。</li>
<li>**<code>app = Flask(__name__)</code>**： 这行代码创建了一个 Flask 应用实例。<code>__name__</code> 是一个特殊的 Python 变量，它在模块被直接运行时是 <code>&#39;__main__&#39;</code>，在被其他模块导入时是模块的名字。传递 <code>__name__</code> 给 <code>Flask</code> 构造函数允许 Flask 应用找到和加载配置文件。</li>
<li>**<code>@app.route(&#39;/&#39;)</code>**： 这是一个装饰器，用于告诉 Flask 哪个 URL 应该触发下面的函数。在这个例子中，它指定了根 URL（即网站的主页）。</li>
<li>**<code>if__name__ == &#39;__main__&#39;</code>**：这行代码是一个条件判断，用于检查这个模块是否被直接运行，而不是被其他模块导入。如果是直接运行，下面的代码块将被执行。</li>
<li>**<code>app.run(debug=True)</code>**：这行代码调用 Flask 应用实例的 <code>run</code> 方法，启动 Flask 内置的开发服务器。<code>debug=True</code> 参数会启动调试模式，这意味着应用会在代码改变时自动重新加载。</li>
</ul>
<h1 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h1><h2 id="简单项目"><a href="#简单项目" class="headerlink" title="简单项目"></a>简单项目</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">my_flask_app/</span><br><span class="line">│</span><br><span class="line">├── app.py</span><br><span class="line">└── requirements.txt</span><br></pre></td></tr></table></figure>

<ul>
<li>**<code>app.py</code>**：主要的 Flask 应用文件，包含路由和视图函数的定义。</li>
<li>**<code>requirements.txt</code>**：列出项目的依赖库，用于记录 Flask 和其他包的版本信息。</li>
</ul>
<p>my_flask_app 目录下的 app.py 文件代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">home</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello, World!&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<h2 id="中型项目"><a href="#中型项目" class="headerlink" title="中型项目"></a>中型项目</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">my_flask_app/</span><br><span class="line">│</span><br><span class="line">├── app/</span><br><span class="line">│   ├── __init__.py</span><br><span class="line">│   ├── routes.py</span><br><span class="line">│   └── models.py</span><br><span class="line">│</span><br><span class="line">├── config.py</span><br><span class="line">├── requirements.txt</span><br><span class="line">└── run.py</span><br></pre></td></tr></table></figure>

<ul>
<li><code>app/</code>：包含 Flask 应用的主要代码。<ul>
<li>**<code>__init__.py</code>**：初始化 Flask 应用和配置扩展。</li>
<li>**<code>routes.py</code>**：定义应用的路由和视图函数。</li>
<li>**<code>models.py</code>**：定义应用的数据模型。</li>
</ul>
</li>
<li>**<code>config.py</code>**：配置文件，包含应用的配置信息。</li>
<li>**<code>requirements.txt</code>**：列出项目的依赖库。</li>
<li>**<code>run.py</code>**：用于启动 Flask 应用。</li>
</ul>
<p>app&#x2F;_<em>init</em>_.py 示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_app</span>():</span><br><span class="line">    app = Flask(__name__)</span><br><span class="line">    app.config.from_object(<span class="string">&#x27;config.Config&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">from</span> . <span class="keyword">import</span> routes</span><br><span class="line">    app.register_blueprint(routes.bp)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> app</span><br></pre></td></tr></table></figure>

<p>app&#x2F;routes.py 示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint</span><br><span class="line"></span><br><span class="line">bp = Blueprint(<span class="string">&#x27;main&#x27;</span>, __name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@bp.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">home</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello, World!&#x27;</span></span><br></pre></td></tr></table></figure>

<p>run.py 示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> app <span class="keyword">import</span> create_app</span><br><span class="line"></span><br><span class="line">app = create_app()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<h2 id="复杂项目"><a href="#复杂项目" class="headerlink" title="复杂项目"></a>复杂项目</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">my_flask_app/</span><br><span class="line">│</span><br><span class="line">├── app/</span><br><span class="line">│   ├── __init__.py</span><br><span class="line">│   ├── routes/</span><br><span class="line">│   │   ├── __init__.py</span><br><span class="line">│   │   ├── main.py</span><br><span class="line">│   │   └── auth.py</span><br><span class="line">│   ├── models/</span><br><span class="line">│   │   ├── __init__.py</span><br><span class="line">│   │   └── user.py</span><br><span class="line">│   ├── templates/</span><br><span class="line">│   │   ├── layout.html</span><br><span class="line">│   │   └── home.html</span><br><span class="line">│   └── static/</span><br><span class="line">│       ├── css/</span><br><span class="line">│       └── js/</span><br><span class="line">│</span><br><span class="line">├── config.py</span><br><span class="line">├── requirements.txt</span><br><span class="line">├── migrations/</span><br><span class="line">│   └── ...</span><br><span class="line">└── run.py</span><br></pre></td></tr></table></figure>

<ul>
<li><code>app/routes/</code>：将不同功能模块的路由分开管理。<ul>
<li>**<code>main.py</code>**：主模块的路由。</li>
<li>**<code>auth.py</code>**：认证相关的路由。</li>
</ul>
</li>
<li><code>app/models/</code>：管理数据模型，通常与数据库操作相关。<ul>
<li>**<code>user.py</code>**：用户模型。</li>
</ul>
</li>
<li>**<code>app/templates/</code>**：存放 HTML 模板文件。</li>
<li>**<code>app/static/</code>**：存放静态文件，如 CSS 和 JavaScript。</li>
<li>**<code>migrations/</code>**：数据库迁移文件，通常与 SQLAlchemy 相关。</li>
</ul>
<p>app&#x2F;routes&#x2F;main.py 示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint, render_template</span><br><span class="line"></span><br><span class="line">bp = Blueprint(<span class="string">&#x27;main&#x27;</span>, __name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@bp.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">home</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;home.html&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>app&#x2F;models&#x2F;user.py 示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> app <span class="keyword">import</span> db</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(db.Model):</span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    username = db.Column(db.String(<span class="number">150</span>), unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<h1 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h1><p>Flask 路由是 Web 应用程序中将 URL 映射到 Python 函数的机制。</p>
<p>以下是关于 Flask 路由的详细说明。</p>
<ol>
<li><strong>定义路由</strong>：使用 <code>@app.route(&#39;/path&#39;)</code> 装饰器定义 URL 和视图函数的映射。</li>
<li><strong>路由参数</strong>：通过动态部分在 URL 中传递参数。</li>
<li><strong>路由规则</strong>：使用类型转换器指定 URL 参数的类型。</li>
<li><strong>请求方法</strong>：指定允许的 HTTP 请求方法。</li>
<li><strong>路由函数返回</strong>：视图函数可以返回不同类型的响应。</li>
<li><strong>静态文件和模板</strong>：管理静态文件和动态渲染 HTML 模板。</li>
<li><strong>路由优先级</strong>：确保路由顺序正确，以避免意外的匹配结果。</li>
</ol>
<h2 id="定义路由"><a href="#定义路由" class="headerlink" title="定义路由"></a>定义路由</h2><p>基本路由定义：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">home</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Welcome to the Home Page!&#x27;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>@app.route(&#39;/&#39;)</code>：装饰器，用于定义路由。<code>/</code> 表示根 URL。</li>
<li><code>def home()</code>：视图函数，当访问根 URL 时，返回 <code>&#39;Welcome to the Home Page!&#39;</code> 。</li>
</ul>
<h2 id="路由参数"><a href="#路由参数" class="headerlink" title="路由参数"></a>路由参数</h2><p>路由可以包含动态部分，通过在路由中指定参数，可以将 URL 中的部分数据传递给视图函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/greet/&lt;name&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">greet</span>(<span class="params">name</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&#x27;Hello, <span class="subst">&#123;name&#125;</span>!&#x27;</span></span><br></pre></td></tr></table></figure>

<p>请求 URL 示例：<code>http://localhost:5000/greet/peter</code></p>
<h2 id="路由规则"><a href="#路由规则" class="headerlink" title="路由规则"></a>路由规则</h2><p>路由规则支持不同类型的参数和匹配规则。</p>
<p>类型规则：</p>
<ul>
<li><strong>字符串（默认）：</strong> 匹配任意字符串。</li>
<li><strong>整数（<code>&lt;int:name&gt;</code>）：</strong> 匹配整数值。</li>
<li><strong>浮点数（<code>&lt;float:value&gt;</code>）：</strong> 匹配浮点数值。</li>
<li><strong>路径（<code>&lt;path:name&gt;</code>）：</strong> 匹配任意字符，包括斜杠 <code>/</code>。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/user/&lt;int:user_id&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">user_profile</span>(<span class="params">user_id</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&#x27;User ID: <span class="subst">&#123;user_id&#125;</span>&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/files/&lt;path:filename&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">serve_file</span>(<span class="params">filename</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&#x27;Serving file: <span class="subst">&#123;filename&#125;</span>&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="请求方法"><a href="#请求方法" class="headerlink" title="请求方法"></a>请求方法</h2><p>可以通过 methods 参数指定允许的请求方法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/submit&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">submit</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Form submitted!&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="路由转换器"><a href="#路由转换器" class="headerlink" title="路由转换器"></a>路由转换器</h2><p>Flask 提供了一些内置的转换器，可以对 URL 中的参数进行特定类型的转换。</p>
<p>常用转换器：</p>
<ul>
<li><strong><code>int</code>：</strong> 匹配整数。</li>
<li><strong><code>float</code>：</strong> 匹配浮点数。</li>
<li><strong><code>path</code>：</strong> 匹配任意路径，包括斜杠。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/items/&lt;int:item_id&gt;/details&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">item_details</span>(<span class="params">item_id</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&#x27;Item details for item ID: <span class="subst">&#123;item_id&#125;</span>&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="路由函数返回"><a href="#路由函数返回" class="headerlink" title="路由函数返回"></a>路由函数返回</h2><p>视图函数可以返回多种类型的响应：</p>
<ul>
<li><strong>字符串</strong>：返回纯文本响应。</li>
<li><strong>HTML</strong>：返回 HTML 页面。</li>
<li><strong>JSON</strong>：返回 JSON 数据。</li>
<li><strong>Response 对象</strong>：自定义响应。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> jsonify, Response</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/json&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">json_response</span>():</span><br><span class="line">    data = &#123;<span class="string">&#x27;key&#x27;</span>: <span class="string">&#x27;value&#x27;</span>&#125;</span><br><span class="line">    <span class="keyword">return</span> jsonify(data)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/custom&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">custom_response</span>():</span><br><span class="line">    response = Response(<span class="string">&#x27;Custom response with headers&#x27;</span>, status=<span class="number">200</span>)</span><br><span class="line">    response.headers[<span class="string">&#x27;X-Custom-Header&#x27;</span>] = <span class="string">&#x27;Value&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>

<ul>
<li><code>jsonify(data)</code>：将字典转换为 JSON 响应。</li>
<li><code>Response(&#39;Custom response with headers&#39;, status=200)</code>：创建自定义响应对象。”Custom response with headers” 为响应主体的内容，将显示在响应页面中。</li>
</ul>
<h2 id="静态文件和模板"><a href="#静态文件和模板" class="headerlink" title="静态文件和模板"></a>静态文件和模板</h2><p>静态文件（如 CSS、JavaScript、图片）可以通过 static 路由访问。模板文件则通过 templates 文件夹组织，用于渲染 HTML 页面。</p>
<p>静态文件访问：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;&#123;&#123; url_for(&#x27;static&#x27;, filename=&#x27;style.css&#x27;) &#125;&#125;&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>模板文件渲染：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> render_template</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/hello/&lt;name&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello</span>(<span class="params">name</span>):</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;hello.html&#x27;</span>, name=name)</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Hello<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello, &#123;&#123; name &#125;&#125;!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="路由优先级"><a href="#路由优先级" class="headerlink" title="路由优先级"></a>路由优先级</h2><p>Flask 按照定义的顺序匹配路由，第一个匹配成功的路由将被处理。确保更具体的路由放在更一般的路由之前。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/user/&lt;int:user_id&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">user_profile</span>(<span class="params">user_id</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&#x27;User ID: <span class="subst">&#123;user_id&#125;</span>&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/user&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">user_list</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;User List&#x27;</span></span><br></pre></td></tr></table></figure>

<h1 id="视图函数"><a href="#视图函数" class="headerlink" title="视图函数"></a>视图函数</h1><p>视图函数是 Flask 应用中的核心部分，它负责处理请求并生成响应。</p>
<p>视图函数与路由紧密结合，通过路由将 URL 映射到具体的视图函数。</p>
<p>以下是对 Flask 视图函数的详细说明。</p>
<ol>
<li><strong>定义视图函数</strong>：视图函数是处理请求并返回响应的核心功能。</li>
<li><strong>接收请求数据</strong>：使用 <code>request</code> 对象获取 URL 参数、表单数据、查询参数等。</li>
<li><strong>返回响应</strong>：可以返回字符串、HTML、JSON 或自定义响应对象。</li>
<li><strong>处理请求和响应</strong>：使用 <code>request</code> 对象处理请求，使用 <code>make_response</code> 生成自定义响应。</li>
<li><strong>处理错误</strong>：视图函数内处理异常或使用 Flask 的错误处理机制。</li>
<li><strong>视图函数的装饰器</strong>：使用 <code>@app.before_request</code>、<code>@app.after_request</code> 等装饰器处理请求前后逻辑。</li>
<li><strong>视图函数返回的状态码</strong>：可以指定 HTTP 状态码来表示请求的处理结果。</li>
</ol>
<h2 id="定义视图函数"><a href="#定义视图函数" class="headerlink" title="定义视图函数"></a>定义视图函数</h2><p>视图函数是一个普通的 Python 函数，它接收请求并返回响应。视图函数通常与路由配合使用，通过装饰器将 URL 映射到视图函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">home</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello, World!&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="接收请求数据"><a href="#接收请求数据" class="headerlink" title="接收请求数据"></a>接收请求数据</h2><p>视图函数可以接收不同类型的请求数据，包括 URL 参数、表单数据、查询参数等。</p>
<p>获取 URL 参数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/greet/&lt;name&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">greet</span>(<span class="params">name</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&#x27;Hello, <span class="subst">&#123;name&#125;</span>!&#x27;</span></span><br></pre></td></tr></table></figure>

<p>用户输入的数据可能包含恶意代码，所以不建议直接作为响应返回，需要使用 MarkupSafe 提供的 <code>escape()</code> 函数对 <code>name</code> 变量进行转义处理，防止触发代码执行漏洞。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> markupsafe <span class="keyword">import</span> escape</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/greet/&lt;name&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">greet</span>(<span class="params">name</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&#x27;Hello, <span class="subst">&#123;escape(name)&#125;</span>!&#x27;</span></span><br></pre></td></tr></table></figure>

<p>获取表单数据：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/submit&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">submit</span>():</span><br><span class="line">    username = request.form.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&#x27;Form submitted by <span class="subst">&#123;username&#125;</span>!&#x27;</span></span><br></pre></td></tr></table></figure>

<p>**request.form.get(‘username’)**：获取 POST 请求中表单数据的 username 字段。</p>
<p>获取查询参数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/search&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">search</span>():</span><br><span class="line">    query = request.args.get(<span class="string">&#x27;query&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&#x27;Search results for: <span class="subst">&#123;query&#125;</span>&#x27;</span></span><br></pre></td></tr></table></figure>

<p>**request.args.get(‘query’)**：获取 GET 请求中的查询参数 query。</p>
<h2 id="返回响应"><a href="#返回响应" class="headerlink" title="返回响应"></a>返回响应</h2><p>视图函数可以返回多种类型的响应，包括字符串、HTML、JSON、或自定义响应对象。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 返回字符串</span></span><br><span class="line"><span class="keyword">return</span> <span class="string">&#x27;This is a simple message.&#x27;</span></span><br><span class="line"><span class="comment"># 返回 HTML 模板</span></span><br><span class="line"><span class="keyword">return</span> render_template(<span class="string">&#x27;hello.html&#x27;</span>, name=name)</span><br><span class="line"><span class="comment"># 返回 JSON 数据</span></span><br><span class="line">data = &#123;<span class="string">&#x27;key&#x27;</span>: <span class="string">&#x27;value&#x27;</span>&#125;</span><br><span class="line"><span class="keyword">return</span> jsonify(data)</span><br><span class="line"><span class="comment"># 返回自定义响应对象</span></span><br><span class="line">response = Response(<span class="string">&#x27;Custom response with headers&#x27;</span>, status=<span class="number">200</span>)</span><br><span class="line">response.headers[<span class="string">&#x27;X-Custom-Header&#x27;</span>] = <span class="string">&#x27;Value&#x27;</span></span><br><span class="line"><span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>

<p>注意 Flask 期望视图函数返回一个有效的 HTTP 响应类型（如字符串、字典、列表、元组、Response 实例等），像这种写法会报错：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h2 id="处理请求和响应"><a href="#处理请求和响应" class="headerlink" title="处理请求和响应"></a>处理请求和响应</h2><p>视图函数可以访问请求对象，并根据请求数据生成响应。可以使用 request 对象来获取请求的信息，使用 make_response 来创建自定义响应。</p>
<p>使用 request 对象：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/info&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">info</span>():</span><br><span class="line">    user_agent = request.headers.get(<span class="string">&#x27;User-Agent&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&#x27;Your user agent is <span class="subst">&#123;user_agent&#125;</span>&#x27;</span></span><br></pre></td></tr></table></figure>

<p>**request.headers.get(‘User-Agent’)**：获取请求头中的 User-Agent 信息。</p>
<p>使用 make_response：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> make_response</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/header&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">custom_header</span>():</span><br><span class="line">    response = make_response(<span class="string">&#x27;Response with custom header&#x27;</span>)</span><br><span class="line">    response.headers[<span class="string">&#x27;X-Custom-Header&#x27;</span>] = <span class="string">&#x27;Value&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>

<p>**make_response(‘Response with custom header’)**：创建响应对象并设置自定义头信息。</p>
<p>“Response with custom header” 是响应主体的内容，将显示在响应页面中。</p>
<h2 id="处理错误"><a href="#处理错误" class="headerlink" title="处理错误"></a>处理错误</h2><p>可以在视图函数中处理异常或错误，或者通过 Flask 提供的错误处理机制来处理应用中的错误。</p>
<p>在视图函数中处理错误：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/divide/&lt;int:x&gt;/&lt;int:y&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">divide</span>(<span class="params">x, y</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        result = x / y</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&#x27;Result: <span class="subst">&#123;result&#125;</span>&#x27;</span></span><br><span class="line">    <span class="keyword">except</span> ZeroDivisionError:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Error: Division by zero&#x27;</span>, <span class="number">400</span></span><br></pre></td></tr></table></figure>

<p>全局错误处理：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.errorhandler(<span class="params"><span class="number">404</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">not_found</span>(<span class="params">error</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Page not found&#x27;</span>, <span class="number">404</span></span><br></pre></td></tr></table></figure>

<h2 id="视图函数的装饰器"><a href="#视图函数的装饰器" class="headerlink" title="视图函数的装饰器"></a>视图函数的装饰器</h2><p>一个视图函数也可以绑定多个 URL，这通过附加多个装饰器实现，比如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/index&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/home&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello Flask!&#x27;</span></span><br></pre></td></tr></table></figure>

<p>除了 @app.route，Flask 还支持其他装饰器，用于实现更复杂的功能。</p>
<p>示例：</p>
<ul>
<li>**<code>@app.before_request</code>**：在每个请求处理之前运行的函数。</li>
<li>**<code>@app.after_request</code>**：在每个请求处理之后运行的函数。</li>
<li>**<code>@app.teardown_request</code>**：在请求结束后运行的函数，用于清理工作。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.before_request</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">before_request</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Before request&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.after_request</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">after_request</span>(<span class="params">response</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;After request&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.teardown_request</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">teardown_request</span>(<span class="params">exception</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Teardown request&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="视图函数返回状态码"><a href="#视图函数返回状态码" class="headerlink" title="视图函数返回状态码"></a>视图函数返回状态码</h2><p>指定 HTTP 状态码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/status&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">status</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Everything is OK&#x27;</span>, <span class="number">200</span></span><br></pre></td></tr></table></figure>

<p>返回带有状态码的响应对象：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Response</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/error&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">error</span>():</span><br><span class="line">    <span class="keyword">return</span> Response(<span class="string">&#x27;An error occurred&#x27;</span>, status=<span class="number">500</span>)</span><br></pre></td></tr></table></figure>

<h2 id="一个标准的视图函数"><a href="#一个标准的视图函数" class="headerlink" title="一个标准的视图函数"></a>一个标准的视图函数</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request, jsonify</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">   <span class="keyword">if</span> request.method==<span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">      data = request.get_json()</span><br><span class="line">      title = data.get(<span class="string">&#x27;title&#x27;</span>)</span><br><span class="line">      year = data.get(<span class="string">&#x27;year&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;msg&quot;</span>: <span class="string">&quot;POST OK&quot;</span>&#125;), <span class="number">200</span></span><br><span class="line">   <span class="keyword">elif</span> request.method==<span class="string">&#x27;GET&#x27;</span>:</span><br><span class="line">      title = request.args.get(<span class="string">&#x27;title&#x27;</span>)</span><br><span class="line">      year = request.args.get(<span class="string">&#x27;year&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;msg&quot;</span>: <span class="string">&quot;GET OK&quot;</span>&#125;), <span class="number">200</span></span><br></pre></td></tr></table></figure>

<h1 id="模板渲染"><a href="#模板渲染" class="headerlink" title="模板渲染"></a>模板渲染</h1><p>Flask 使用 Jinja2 模板引擎来处理模板渲染。</p>
<p>关于模板的详细内容见 Django 学习笔记。</p>
<h1 id="表单处理"><a href="#表单处理" class="headerlink" title="表单处理"></a>表单处理</h1><p>Flask 提供了基本的表单处理功能，但通常结合 Flask-WTF 扩展来简化表单操作和验证。</p>
<h2 id="基本表单处理"><a href="#基本表单处理" class="headerlink" title="基本表单处理"></a>基本表单处理</h2><p>Flask 提供了直接处理表单数据的方式，使用 request 对象来获取提交的数据。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">form</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;form.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/submit&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">submit</span>():</span><br><span class="line">    name = request.form.get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">    email = request.form.get(<span class="string">&#x27;email&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&#x27;Name: <span class="subst">&#123;name&#125;</span>, Email: <span class="subst">&#123;email&#125;</span>&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<h2 id="使用Flask-WTF扩展"><a href="#使用Flask-WTF扩展" class="headerlink" title="使用Flask-WTF扩展"></a>使用Flask-WTF扩展</h2><p>Flask-WTF 是一个封装了 WTForms 的扩展，提供了表单处理和验证的功能，使得表单处理更加简洁和强大。</p>
<p>安装 Flask-WTF：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install flask-wtf</span><br></pre></td></tr></table></figure>

<p>配置 Flask-WTF：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app.py</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, redirect, url_for</span><br><span class="line"><span class="keyword">from</span> flask_wtf <span class="keyword">import</span> FlaskForm</span><br><span class="line"><span class="keyword">from</span> wtforms <span class="keyword">import</span> StringField, EmailField, SubmitField</span><br><span class="line"><span class="keyword">from</span> wtforms.validators <span class="keyword">import</span> DataRequired, Email</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.secret_key = <span class="string">&#x27;your_secret_key&#x27;</span>  <span class="comment"># Required for form protection</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyForm</span>(<span class="title class_ inherited__">FlaskForm</span>):</span><br><span class="line">    name = StringField(<span class="string">&#x27;Name&#x27;</span>, validators=[DataRequired()])</span><br><span class="line">    email = EmailField(<span class="string">&#x27;Email&#x27;</span>, validators=[DataRequired(), Email()])</span><br><span class="line">    submit = SubmitField(<span class="string">&#x27;Submit&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">form</span>():</span><br><span class="line">    form = MyForm()</span><br><span class="line">    <span class="keyword">if</span> form.validate_on_submit():</span><br><span class="line">        name = form.name.data</span><br><span class="line">        email = form.email.data</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&#x27;Name: <span class="subst">&#123;name&#125;</span>, Email: <span class="subst">&#123;email&#125;</span>&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;form.html&#x27;</span>, form=form)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>DataRequired()</code>：确保字段不为空。</li>
<li><code>Email()</code>：验证字段是否为有效的电子邮件地址。</li>
</ul>
<p>创建模板以支持 Flask-WTF 表单：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Form Example<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">        &#123;&#123; form.hidden_tag() &#125;&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">            &#123;&#123; form.name.label &#125;&#125;<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">            &#123;&#123; form.name(size=32) &#125;&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">            &#123;&#123; form.email.label &#125;&#125;<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">            &#123;&#123; form.email(size=32) &#125;&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">            &#123;&#123; form.submit() &#125;&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>**<code>&#123;&#123; form.hidden_tag() &#125;&#125;</code>**：生成隐藏字段，用于保护表单免受 CSRF 攻击。</p>
<h2 id="表单验证"><a href="#表单验证" class="headerlink" title="表单验证"></a>表单验证</h2><p>Flask-WTF 和 WTForms 提供了丰富的表单验证功能。你可以使用内置的验证器或自定义验证器来确保表单数据的有效性。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> wtforms <span class="keyword">import</span> Form, StringField, EmailField, SubmitField</span><br><span class="line"><span class="keyword">from</span> wtforms.validators <span class="keyword">import</span> DataRequired, Email, Length</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyForm</span>(<span class="title class_ inherited__">FlaskForm</span>):</span><br><span class="line">    name = StringField(<span class="string">&#x27;Name&#x27;</span>, validators=[</span><br><span class="line">        DataRequired(), Length(<span class="built_in">min</span>=<span class="number">1</span>, <span class="built_in">max</span>=<span class="number">50</span>)</span><br><span class="line">    ])</span><br><span class="line">    email = EmailField(<span class="string">&#x27;Email&#x27;</span>, validators=[</span><br><span class="line">        DataRequired(), Email()</span><br><span class="line">    ])</span><br><span class="line">    submit = SubmitField(<span class="string">&#x27;Submit&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>validators 用于定义表单字段的验证规则。</p>
<h2 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h2><p>上传的文件可以通过 <strong>request.files</strong> 访问。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;Upload File&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;form action=<span class="string">&quot;/upload&quot;</span> method=<span class="string">&quot;post&quot;</span> enctype=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span><br><span class="line">        &lt;label <span class="keyword">for</span>=<span class="string">&quot;file&quot;</span>&gt;File:&lt;/label&gt;</span><br><span class="line">        &lt;<span class="built_in">input</span> <span class="built_in">type</span>=<span class="string">&quot;file&quot;</span> <span class="built_in">id</span>=<span class="string">&quot;file&quot;</span> name=<span class="string">&quot;file&quot;</span>&gt;</span><br><span class="line">        &lt;br&gt;</span><br><span class="line">        &lt;<span class="built_in">input</span> <span class="built_in">type</span>=<span class="string">&quot;submit&quot;</span> value=<span class="string">&quot;Upload&quot;</span>&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, redirect, url_for</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.secret_key = <span class="string">&#x27;your_secret_key&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/upload&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload</span>():</span><br><span class="line">    file = request.files.get(<span class="string">&#x27;file&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> file:</span><br><span class="line">        filename = file.filename</span><br><span class="line">        file.save(<span class="string">f&#x27;uploads/<span class="subst">&#123;filename&#125;</span>&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&#x27;File uploaded successfully: <span class="subst">&#123;filename&#125;</span>&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;No file uploaded&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<h2 id="CSRF保护"><a href="#CSRF保护" class="headerlink" title="CSRF保护"></a>CSRF保护</h2><p>Flask-WTF 自动为表单提供 CSRF 保护。你需要配置一个密钥来启用 CSRF 保护，并在模板中包含隐藏的 CSRF 令牌。</p>
<p>配置 CSRF 保护：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.secret_key = <span class="string">&#x27;your_secret_key&#x27;</span></span><br></pre></td></tr></table></figure>

<p>在模板中添加 CSRF 令牌：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;form method=<span class="string">&quot;post&quot;</span>&gt;</span><br><span class="line">    &#123;&#123; form.hidden_tag() &#125;&#125;</span><br><span class="line">    &lt;!-- Form fields here --&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>

<h1 id="数据库操作"><a href="#数据库操作" class="headerlink" title="数据库操作"></a>数据库操作</h1><h2 id="使用Flask-SQLAlchemy"><a href="#使用Flask-SQLAlchemy" class="headerlink" title="使用Flask-SQLAlchemy"></a>使用Flask-SQLAlchemy</h2><p>SQLAlchemy 是一个强大的 ORM（对象关系映射）库，可以简化数据库操作，通过 Python 对象与数据库表进行交互。</p>
<p>借助 SQLAlchemy，你可以通过定义 Python 类来表示数据库里的一张表（类属性表示表中的字段&#x2F;列），通过对这个类进行各种操作来代替写 SQL 语句。这个类我们称之为模型类，类中的属性我们将称之为字段。</p>
<p>Flask-SQLAlchemy 是 Flask 的一个扩展，用于集成 SQLAlchemy。</p>
<p>安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install flask-sqlalchemy</span><br></pre></td></tr></table></figure>

<h3 id="配置SQLAlchemy"><a href="#配置SQLAlchemy" class="headerlink" title="配置SQLAlchemy"></a>配置SQLAlchemy</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app.py</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>] = <span class="string">&#x27; mysql://username:password@localhost/dbname&#x27;</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_TRACK_MODIFICATIONS&#x27;</span>] = <span class="literal">False</span></span><br><span class="line">db = SQLAlchemy(app)</span><br></pre></td></tr></table></figure>

<p><strong><code>SQLALCHEMY_TRACK_MODIFICATIONS</code></strong> 主要用于监控并跟踪 SQLAlchemy 模型对象的变动，以便发出信号。</p>
<p>设置为 False 的作用：</p>
<ul>
<li>性能优化：当 <code>SQLALCHEMY_TRACK_MODIFICATIONS</code> 设置为 <code>True</code> 时，SQLAlchemy 会额外占用一些内存去跟踪对象的修改。这在较大或频繁操作的项目中会导致一定的性能开销。因此，一般将其设置为 <code>False</code> 来禁用跟踪，以提升应用性能。</li>
<li>消除警告：如果未显式设置此项，Flask-SQLAlchemy 会在应用启动时发出警告，建议将其关闭以减少资源占用。</li>
</ul>
<h3 id="定义模型"><a href="#定义模型" class="headerlink" title="定义模型"></a>定义模型</h3><p>模型是数据库表的 Python 类，每个模型类代表数据库中的一张表。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(db.Model):</span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    username = db.Column(db.String(<span class="number">80</span>), unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>)</span><br><span class="line">    email = db.Column(db.String(<span class="number">120</span>), unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&#x27;&lt;User <span class="subst">&#123;self.username&#125;</span>&gt;&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>db.Model</strong>：所有模型类需要继承自 db.Model。</p>
<p><strong>db.Column</strong>：定义模型的字段，指定字段的类型、是否为主键、是否唯一、是否可以为空等属性。</p>
<p>**<code>unique</code>**：</p>
<ul>
<li>作用：当设置为 <code>True</code> 时，表示该字段的值在数据库中必须是唯一的。即，同一列中的所有值不能重复。</li>
<li>应用场景：适用于需要唯一标识的字段，例如用户名、电子邮件地址等。确保在插入数据时不会出现重复值。</li>
<li>数据库约束：当插入或更新数据时，如果试图插入重复值，会抛出数据库错误。</li>
</ul>
<p>**<code>nullable</code>**：</p>
<ul>
<li>作用：当设置为 <code>True</code> 时，表示该字段可以接受 <code>NULL</code> 值（即不需要提供值）。如果设置为 <code>False</code>，则表示该字段不能为空，必须提供一个有效值。</li>
<li>应用场景：适用于某些情况下可以省略的字段。例如，某些用户资料可以不提供，但用户名通常需要提供。</li>
<li>数据库约束：如果试图插入或更新为 <code>NULL</code> 值时，若该字段设置为 <code>nullable=False</code>，会抛出数据库错误。</li>
</ul>
<p>**<code>__repr__</code>**：一个特殊的方法，用于定义对象的“官方”字符串表示。它主要用于调试和开发，帮助开发者更好地理解和查看对象的状态。示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">user = User(username=<span class="string">&#x27;carl&#x27;</span>, email=<span class="string">&#x27;carl@example.com&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(user)</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">&lt;User carl&gt;</span><br></pre></td></tr></table></figure>

<h3 id="创建数据表"><a href="#创建数据表" class="headerlink" title="创建数据表"></a>创建数据表</h3><p>在定义了模型后，你可以使用 SQLAlchemy 提供的方法来创建数据库和表。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> app.app_context():</span><br><span class="line">    db.create_all()</span><br></pre></td></tr></table></figure>

<p>**db.create_all()**：创建所有在当前上下文中定义的模型对应的表。</p>
<h3 id="基本的CRUD操作"><a href="#基本的CRUD操作" class="headerlink" title="基本的CRUD操作"></a>基本的CRUD操作</h3><h4 id="创建记录"><a href="#创建记录" class="headerlink" title="创建记录"></a>创建记录</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/add_user&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_user</span>():</span><br><span class="line">    new_user = User(username=<span class="string">&#x27;john_doe&#x27;</span>, email=<span class="string">&#x27;john@example.com&#x27;</span>)</span><br><span class="line">    db.session.add(new_user)</span><br><span class="line">    db.session.commit()</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;User added!&#x27;</span></span><br></pre></td></tr></table></figure>

<p>**db.session.add(new_user)**：将新用户对象添加到会话中。</p>
<p>**db.session.commit()**：提交事务，将更改保存到数据库。</p>
<h4 id="读取记录"><a href="#读取记录" class="headerlink" title="读取记录"></a>读取记录</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/get_users&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_users</span>():</span><br><span class="line">    users = User.query.<span class="built_in">all</span>()  <span class="comment"># 获取所有用户</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&lt;br&gt;&#x27;</span>.join([<span class="string">f&#x27;<span class="subst">&#123;user.username&#125;</span> (<span class="subst">&#123;user.email&#125;</span>)&#x27;</span> <span class="keyword">for</span> user <span class="keyword">in</span> users])</span><br></pre></td></tr></table></figure>

<p>**User.query.all()**：查询所有用户记录。</p>
<h4 id="更新记录"><a href="#更新记录" class="headerlink" title="更新记录"></a>更新记录</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/update_user/&lt;int:user_id&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">update_user</span>(<span class="params">user_id</span>):</span><br><span class="line">    user = User.query.get(user_id)</span><br><span class="line">    <span class="keyword">if</span> user:</span><br><span class="line">        user.username = <span class="string">&#x27;new_username&#x27;</span></span><br><span class="line">        db.session.commit()</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;User updated!&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;User not found!&#x27;</span></span><br></pre></td></tr></table></figure>

<p>**User.query.get(user_id)**：通过主键查询单个用户记录。</p>
<p>更新字段值并提交事务。</p>
<h4 id="删除记录"><a href="#删除记录" class="headerlink" title="删除记录"></a>删除记录</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/delete_user/&lt;int:user_id&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete_user</span>(<span class="params">user_id</span>):</span><br><span class="line">    user = User.query.get(user_id)</span><br><span class="line">    <span class="keyword">if</span> user:</span><br><span class="line">        db.session.delete(user)</span><br><span class="line">        db.session.commit()</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;User deleted!&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;User not found!&#x27;</span></span><br></pre></td></tr></table></figure>

<p>**db.session.delete(user)**：删除用户记录，并提交事务。</p>
<h3 id="查询操作"><a href="#查询操作" class="headerlink" title="查询操作"></a>查询操作</h3><p>SQLAlchemy 提供了丰富的查询功能，可以通过查询对象来执行各种查询操作。</p>
<h4 id="基本查询"><a href="#基本查询" class="headerlink" title="基本查询"></a>基本查询</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">users = User.query.filter_by(username=<span class="string">&#x27;john_doe&#x27;</span>).<span class="built_in">all</span>()</span><br></pre></td></tr></table></figure>

<p>**filter_by()**：根据字段值过滤记录。</p>
<h4 id="复杂查询"><a href="#复杂查询" class="headerlink" title="复杂查询"></a>复杂查询</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> or_</span><br><span class="line"></span><br><span class="line">users = User.query.<span class="built_in">filter</span>(or_(User.username == <span class="string">&#x27;john_doe&#x27;</span>, User.email == <span class="string">&#x27;john@example.com&#x27;</span>)).<span class="built_in">all</span>()</span><br></pre></td></tr></table></figure>

<p>**or_()**：用于执行复杂的查询条件。</p>
<blockquote>
<p>更多查询操作见后面的“使用 SQLAlchemy 核心模块”的”条件筛选“介绍。</p>
</blockquote>
<h4 id="排序和分页"><a href="#排序和分页" class="headerlink" title="排序和分页"></a>排序和分页</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">users = User.query.order_by(User.username).paginate(page=<span class="number">1</span>, per_page=<span class="number">10</span>)</span><br></pre></td></tr></table></figure>

<p>**order_by()**：按指定字段排序。</p>
<p>**paginate()**：分页查询。</p>
<h3 id="原生SQL"><a href="#原生SQL" class="headerlink" title="原生SQL"></a>原生SQL</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/raw_sql&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">raw_sql</span>():</span><br><span class="line">    result = db.session.execute(<span class="string">&#x27;SELECT * FROM user&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&lt;br&gt;&#x27;</span>.join([<span class="built_in">str</span>(row) <span class="keyword">for</span> row <span class="keyword">in</span> result])</span><br></pre></td></tr></table></figure>

<p>**db.session.execute()**：执行原始 SQL 查询。</p>
<h2 id="使用PyMySQL"><a href="#使用PyMySQL" class="headerlink" title="使用PyMySQL"></a>使用PyMySQL</h2><p>如果不需要 ORM，可以直接使用 PyMySQL 进行操作，适合轻量级的 SQL 查询。</p>
<p>安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install pymysql</span><br></pre></td></tr></table></figure>

<p>操作示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql.cursors</span><br><span class="line"></span><br><span class="line">connection = pymysql.connect(</span><br><span class="line">    host=<span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">    user=<span class="string">&#x27;username&#x27;</span>,</span><br><span class="line">    password=<span class="string">&#x27;password&#x27;</span>,</span><br><span class="line">    database=<span class="string">&#x27;dbname&#x27;</span>,</span><br><span class="line">    cursorclass=pymysql.cursors.DictCursor</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">with</span> connection.cursor() <span class="keyword">as</span> cursor:</span><br><span class="line">        <span class="comment"># 插入数据</span></span><br><span class="line">        sql = <span class="string">&quot;INSERT INTO `users` (`username`, `email`) VALUES (%s, %s)&quot;</span></span><br><span class="line">        cursor.execute(sql, (<span class="string">&#x27;carl&#x27;</span>, <span class="string">&#x27;carl@example.com&#x27;</span>))</span><br><span class="line">    connection.commit()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> connection.cursor() <span class="keyword">as</span> cursor:</span><br><span class="line">        <span class="comment"># 查询数据</span></span><br><span class="line">        sql = <span class="string">&quot;SELECT `id`, `username`, `email` FROM `users` WHERE `username`=%s&quot;</span></span><br><span class="line">        cursor.execute(sql, (<span class="string">&#x27;carl&#x27;</span>,))</span><br><span class="line">        result = cursor.fetchone()</span><br><span class="line">        <span class="built_in">print</span>(result)</span><br><span class="line"></span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    connection.close()</span><br></pre></td></tr></table></figure>

<h2 id="使用SQLAlchemy核心模块"><a href="#使用SQLAlchemy核心模块" class="headerlink" title="使用SQLAlchemy核心模块"></a>使用SQLAlchemy核心模块</h2><p>SQLAlchemy 不仅提供 ORM，还支持核心模式（Core Mode），直接使用 SQL 语句构建和执行查询。</p>
<p>使用 SQLAlchemy 核心模式同样基于 Flask-SQLAlchemy 扩展。</p>
<h3 id="初始化配置"><a href="#初始化配置" class="headerlink" title="初始化配置"></a>初始化配置</h3><p>创建 dataserver 数据库。</p>
<p>在 config.py 中创建初始化类：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DBConfig</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    HOSTNAME = <span class="string">&#x27;127.0.0.1&#x27;</span></span><br><span class="line">    PORT = <span class="number">3306</span></span><br><span class="line">    USERNAME = <span class="string">&#x27;root&#x27;</span></span><br><span class="line">    PASSWORD = <span class="string">&#x27;root&#x27;</span></span><br><span class="line">    DATABASE = <span class="string">&#x27;dataserver&#x27;</span></span><br><span class="line">    SQLALCHEMY_DATABASE_URI = <span class="string">f&#x27;mysql+pymysql://<span class="subst">&#123;USERNAME&#125;</span>:<span class="subst">&#123;PASSWORD&#125;</span>@<span class="subst">&#123;HOSTNAME&#125;</span>:<span class="subst">&#123;PORT&#125;</span>/<span class="subst">&#123;DATABASE&#125;</span>?charset=utf8&#x27;</span></span><br></pre></td></tr></table></figure>

<p>在 _<em>init</em>_.py 中导入 DBConfig ：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> config <span class="keyword">import</span> DBConfig</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment">#添加配置文件</span></span><br><span class="line">app.config.from_object(DBConfig)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将导入放在文件末尾以避免循环导入</span></span><br><span class="line"><span class="keyword">from</span> app <span class="keyword">import</span> routes  </span><br><span class="line"><span class="keyword">from</span> app <span class="keyword">import</span> database</span><br></pre></td></tr></table></figure>

<h3 id="连接数据库"><a href="#连接数据库" class="headerlink" title="连接数据库"></a>连接数据库</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"><span class="keyword">from</span> config <span class="keyword">import</span> DBConfig</span><br><span class="line">    </span><br><span class="line">engine = create_engine(DBConfig.SQLALCHEMY_DATABASE_URI)</span><br></pre></td></tr></table></figure>

<h3 id="映射说明"><a href="#映射说明" class="headerlink" title="映射说明"></a>映射说明</h3><p>在使用 ORM 时主要有两个配置过程：一是数据库表的信息描述处理，二是将类映射到这些表上。它们在 SQLAlchemy 中一起完成，被称为 Declarative。</p>
<p>使用 Declarative 参与的 ORM 映射的类需要被定义为一个指定基类的子类，这个基类含有 ORM 映射中相关类和表的信息。这样的基类称为 declarative base class。这个基类可以通过 declarative_base 来创建。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> declarative_base</span><br><span class="line"></span><br><span class="line">Base = declarative_base()</span><br></pre></td></tr></table></figure>

<p>数据库与 Python 对象的映射主要在体现三个方面：</p>
<ul>
<li>数据库表 (table）映射为 Python 的类 (class)，称为 model</li>
<li>表的字段 (field) 映射为 Column</li>
<li>表的记录 (record）以类的实例 (instance) 来表示</li>
</ul>
<p> 在 sqlalchemy 中表字段的常见类型如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Interger：整型，映射到数据库中是int类型</span><br><span class="line">Float：浮点类型，float</span><br><span class="line">Double：双精度类型</span><br><span class="line">String：字符串类型，需要指定字符串的长度</span><br><span class="line">Boolean：布尔类型</span><br><span class="line">Decimal：定点类型，专门为解决浮点类型精度丢失的问题而设定。Decimal需要传入两个参数，第一个参数标记该字段能存储多少位数，第二个参数表示小数点后有又多少个小数位</span><br><span class="line">Enum：枚举类型</span><br><span class="line">Date：日期类型，年月日</span><br><span class="line">DateTime：时间类型，年月日时分毫秒</span><br><span class="line">Time：时间类型，时分秒</span><br><span class="line">Text：长字符串，可存储6万多个字符，text</span><br><span class="line">LongText：长文本类型，longtext</span><br></pre></td></tr></table></figure>

<p>在指定表字段的映射为 Column 时，不但要指定表字段的数据类型，往往还需要指定字段属性：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">primary_key    #是否为主键</span><br><span class="line">unique         #是否唯一</span><br><span class="line">index          #如果为True，为该列创建索引，提高查询效率</span><br><span class="line">nullable       #是否允许为空</span><br><span class="line">default        #默认值</span><br><span class="line">name           #在数据表中的字段映射</span><br><span class="line">autoincrement  #是否自动增长</span><br><span class="line">onupdate       #更新时执行的函数</span><br><span class="line">comment        #字段描述</span><br></pre></td></tr></table></figure>

<h3 id="创建类"><a href="#创建类" class="headerlink" title="创建类"></a>创建类</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column, Integer, String</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> declarative_base</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"><span class="keyword">from</span> config <span class="keyword">import</span> DBConfig</span><br><span class="line">    </span><br><span class="line">engine = create_engine(DBConfig.SQLALCHEMY_DATABASE_URI)</span><br><span class="line">Base = declarative_base()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Watchlist</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;watchlist&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>, autoincrement=<span class="literal">True</span>, comment=<span class="string">&#x27;ID&#x27;</span>)</span><br><span class="line">    title = Column(String(<span class="number">100</span>), default=<span class="literal">None</span>, nullable=<span class="literal">False</span>, comment=<span class="string">&#x27;标题&#x27;</span>)</span><br><span class="line">    year = Column(Integer, default=<span class="literal">None</span>, nullable=<span class="literal">False</span>, comment=<span class="string">&#x27;年份&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="创建会话"><a href="#创建会话" class="headerlink" title="创建会话"></a>创建会话</h3><p>在一个会话中操作数据库，会话建立在连接上，连接被引擎管理。当第一次使用数据库时，从引擎维护的连接池中获取一个连接使用。</p>
<p>SQLAlchemy 的 Session 是用于管理数据库操作的一个像容器一样的工厂对象。Session 工厂对象中提供 <code>query(), add(), add_all(), commit(), delete(), flush(), rollback(), close()</code> 等方法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column, Integer, String</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> sessionmaker, declarative_base</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"><span class="keyword">from</span> config <span class="keyword">import</span> DBConfig</span><br><span class="line">    </span><br><span class="line">engine = create_engine(DBConfig.SQLALCHEMY_DATABASE_URI)</span><br><span class="line">Base = declarative_base()</span><br><span class="line">sessionFactory = sessionmaker(bind=engine)</span><br><span class="line">Session = sessionFactory()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Watchlist</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;watchlist&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>, autoincrement=<span class="literal">True</span>, comment=<span class="string">&#x27;ID&#x27;</span>)</span><br><span class="line">    title = Column(String(<span class="number">100</span>), default=<span class="literal">None</span>, nullable=<span class="literal">False</span>, comment=<span class="string">&#x27;标题&#x27;</span>)</span><br><span class="line">    year = Column(Integer, default=<span class="literal">None</span>, nullable=<span class="literal">False</span>, comment=<span class="string">&#x27;年份&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="增加"><a href="#增加" class="headerlink" title="增加"></a>增加</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#增加一个</span></span><br><span class="line">w = Watchlist(title=<span class="string">&#x27;AAA&#x27;</span>, year=<span class="number">1999</span>)</span><br><span class="line">Session.add(w)</span><br><span class="line">Session.commit()</span><br><span class="line"></span><br><span class="line"><span class="comment">#增加一些</span></span><br><span class="line">w1 = Watchlist(title=<span class="string">&#x27;BBB&#x27;</span>, year=<span class="number">2000</span>)</span><br><span class="line">w2 = Watchlist(title=<span class="string">&#x27;CCC&#x27;</span>, year=<span class="number">2001</span>)</span><br><span class="line">w3 = Watchlist(title=<span class="string">&#x27;DDD&#x27;</span>, year=<span class="number">2002</span>)</span><br><span class="line">Session.add_all([w1, w2, w3]) <span class="comment">#传入列表</span></span><br><span class="line">Session.commit()</span><br></pre></td></tr></table></figure>

<h3 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h3><p>query() 返回类对象。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查询全部，返回一个列表</span></span><br><span class="line">dataList = Session.query(Watchlist).<span class="built_in">all</span>()</span><br><span class="line"><span class="comment">#查询第一个</span></span><br><span class="line">firstData = Session.query(Watchlist).first()</span><br></pre></td></tr></table></figure>

<h3 id="条件筛选"><a href="#条件筛选" class="headerlink" title="条件筛选"></a>条件筛选</h3><p>Query 对象提供了 filter() 方法和 filter_by() 方法用于数据筛选，filter_by() 适用于简单的关键字参数筛选，filter() 适用于复杂的条件表达式。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Session.query(Student).<span class="built_in">filter</span>(Student.<span class="built_in">id</span>&lt;=<span class="number">3</span>).<span class="built_in">all</span>()</span><br><span class="line">Session.query(Student).<span class="built_in">filter</span>(Student.name==<span class="string">&#x27;张三&#x27;</span>).first()</span><br><span class="line">Session.query(Student).filter_by(name=<span class="string">&#x27;张三&#x27;</span>).first()</span><br></pre></td></tr></table></figure>

<p>如果有两个限制条件是 AND 关系，可以直接使用两次 filter() 处理。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Session.query(Student).<span class="built_in">filter</span>(Student.name==<span class="string">&#x27;张三&#x27;</span>).<span class="built_in">filter</span>(Student.gender==<span class="string">&#x27;男&#x27;</span>).first()</span><br><span class="line"><span class="comment">#或</span></span><br><span class="line">Session.query(Student).filter_by(name=<span class="string">&#x27;张三&#x27;</span>).<span class="built_in">filter</span>(Student.gender==<span class="string">&#x27;男&#x27;</span>).first()</span><br></pre></td></tr></table></figure>

<p>常见的条件筛选：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Session.query(Student).<span class="built_in">filter</span>(Student.<span class="built_in">id</span> &lt;= <span class="number">3</span>).<span class="built_in">all</span>()</span><br><span class="line">Session.query(Student).<span class="built_in">filter</span>(Student.<span class="built_in">id</span> != <span class="number">2</span>).<span class="built_in">all</span>()</span><br><span class="line"><span class="comment">#通配符查询，如like(&#x27;%关键字%&#x27;)</span></span><br><span class="line">Session.query(Student).<span class="built_in">filter</span>(Student.<span class="built_in">id</span>.like(<span class="string">&#x27;%9&#x27;</span>)).<span class="built_in">all</span>()</span><br><span class="line"><span class="comment">#在</span></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> in_</span><br><span class="line">Session.query(Student).<span class="built_in">filter</span>(Student.EDUCATION.in_([<span class="string">&#x27;Bachelor&#x27;</span>, <span class="string">&#x27;Master&#x27;</span>])).<span class="built_in">all</span>()</span><br><span class="line"><span class="comment">#不在</span></span><br><span class="line">Session.query(Student).<span class="built_in">filter</span>(~Student.EDUCATION.in_([<span class="string">&#x27;Bachelor&#x27;</span>, <span class="string">&#x27;Master&#x27;</span>])).<span class="built_in">all</span>()</span><br><span class="line"><span class="comment">#==None为空</span></span><br><span class="line">Session.query(Student).<span class="built_in">filter</span>(Student.MARITAL_STAT==<span class="literal">None</span>).<span class="built_in">all</span>()</span><br><span class="line"><span class="comment">#不为空</span></span><br><span class="line">Session.query(Student).<span class="built_in">filter</span>(Student.MARITAL_STAT!=<span class="literal">None</span>).<span class="built_in">all</span>()</span><br><span class="line"><span class="comment">#and</span></span><br><span class="line">Session.query(Student).<span class="built_in">filter</span>(Student.GENDER==<span class="string">&#x27;Female&#x27;</span>, Student.EDUCATION==<span class="string">&#x27;Bachelor&#x27;</span>).<span class="built_in">all</span>()</span><br><span class="line"><span class="comment">#这个也是and</span></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> and_</span><br><span class="line">Session.query(Student).<span class="built_in">filter</span>(and_(Student.GENDER==<span class="string">&#x27;Female&#x27;</span>, Student.EDUCATION==<span class="string">&#x27;Bachelor&#x27;</span>)).<span class="built_in">all</span>()</span><br><span class="line"><span class="comment">#or</span></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> or_</span><br><span class="line">Session.query(Student).<span class="built_in">filter</span>(or_(Student.MARITAL_STAT==<span class="string">&#x27;Single&#x27;</span>, Student.NR_OF_CHILDREN==<span class="number">0</span>)).<span class="built_in">all</span>()</span><br></pre></td></tr></table></figure>

<p>更多筛选方法：</p>
<p><img src="https://pic.imgdb.cn/item/671f734dd29ded1a8c2fbc4d.jpg"></p>
<p><img src="https://pic.imgdb.cn/item/671f734dd29ded1a8c2fbc4d.jpg"></p>
<h3 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#第一步，查询出要修改的数据</span></span><br><span class="line">w = Session.query(Watchlist).<span class="built_in">filter</span>(Watchlist.<span class="built_in">id</span>==<span class="number">1</span>).first()</span><br><span class="line"><span class="comment">#第二步，修改</span></span><br><span class="line">w.title = <span class="string">&#x27;CCC&#x27;</span></span><br><span class="line"><span class="comment">#第三步，重新添加</span></span><br><span class="line">Session.add(w)</span><br><span class="line"><span class="comment">#第四步，提交</span></span><br><span class="line">Session.commit()</span><br></pre></td></tr></table></figure>

<p>或</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Session.query(Watchlist).<span class="built_in">filter</span>(Watchlist.<span class="built_in">id</span>==<span class="number">1</span>).update(&#123;<span class="string">&#x27;title&#x27;</span>:<span class="string">&#x27;CCC&#x27;</span>&#125;)</span><br><span class="line">Session.commit()</span><br></pre></td></tr></table></figure>

<p>注意没有 <code>Session.query(Watchlist).filter(Watchlist.id==1).first().update(&#123;&#39;title&#39;:&#39;CCC&#39;&#125;)</code> 这种用法。因为 <code>first()</code> 方法返回的是查询结果的第一个对象，而不是一个可更新的查询对象。原因：</p>
<ol>
<li><p><code>first()</code> 方法会执行查询并返回结果集中的第一个对象（如果存在），或者返回  <code>None</code> 。这意味着你在这个情况下得到了一个 <code>Watchlist</code> 对象，而不是一个查询对象。</p>
</li>
<li><p><code>update()</code> 方法是用于查询对象（如 <code>Query</code> 对象）的方法，而不是用于单个对象的方法。单个对象通常会使用属性赋值来更新，即上述的第一种方法。</p>
</li>
</ol>
<h3 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查询</span></span><br><span class="line">w = Session.query(Watchlist).<span class="built_in">filter</span>(Watchlist.<span class="built_in">id</span>==<span class="number">2</span>).first()</span><br><span class="line"><span class="comment">#删除</span></span><br><span class="line">Session.delete(w)</span><br><span class="line"><span class="comment">#提交</span></span><br><span class="line">Session.commit()</span><br></pre></td></tr></table></figure>

<p>或</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查询并删除</span></span><br><span class="line">w = Session.query(Watchlist).<span class="built_in">filter</span>(Watchlist.<span class="built_in">id</span>==<span class="number">1</span>).delete()</span><br><span class="line"><span class="built_in">print</span>(w) <span class="comment">#输出的是删除的行数</span></span><br><span class="line"><span class="comment">#提交</span></span><br><span class="line">Session.commit()</span><br></pre></td></tr></table></figure>

<h3 id="原生SQL-1"><a href="#原生SQL-1" class="headerlink" title="原生SQL"></a>原生SQL</h3><p>从 SQLAlchemy 中导出 text 方法，可以通过 <code>text(SQL语句) </code> 执行原生 sql 。</p>
<p><strong>方法一：使用 Session 执行原生的 SQL 语句。</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> text</span><br><span class="line"></span><br><span class="line">sql = <span class="string">&#x27;select * from watchlist&#x27;</span></span><br><span class="line">rows = Session.execute(text(sql)).fetchall()</span><br><span class="line">result = [<span class="built_in">dict</span>(row._mapping) <span class="keyword">for</span> row <span class="keyword">in</span> rows]</span><br><span class="line"><span class="built_in">print</span>(result)</span><br><span class="line"><span class="comment">#输出：[&#123;&quot;id&quot;:3,&quot;title&quot;:&quot;AAA&quot;,&quot;year&quot;:1999&#125;]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#插入</span></span><br><span class="line">sql = <span class="string">&#x27;insert into watchlist (title, year) values (:name, :year)&#x27;</span></span><br><span class="line">params = &#123;</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;BBB&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;year&#x27;</span>: <span class="number">2001</span></span><br><span class="line">&#125;</span><br><span class="line">Session.execute(text(sql), params)</span><br><span class="line">Session.commit()</span><br></pre></td></tr></table></figure>

<p> <strong>方法二：通过 Engine 对象执行原生的 SQL 语句。</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> text</span><br><span class="line"></span><br><span class="line">sql = <span class="string">&#x27;select * from watchlist&#x27;</span></span><br><span class="line"><span class="keyword">with</span> engine.connect() <span class="keyword">as</span> conn:</span><br><span class="line">    w = conn.execute(text(sql))</span><br><span class="line">    rows = w.fetchall()</span><br><span class="line">    result = [<span class="built_in">dict</span>(row._mapping) <span class="keyword">for</span> row <span class="keyword">in</span> rows]</span><br></pre></td></tr></table></figure>

<h3 id="批量插入数据"><a href="#批量插入数据" class="headerlink" title="批量插入数据"></a>批量插入数据</h3><p><strong>方法一：</strong>每插入一条数据进行一次 commit() 。性能极度拉跨，提交操作非常耗时，因为每次提交都会引起数据库事务的开启和关闭。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> app.__init__ <span class="keyword">import</span> app, db</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> app.app_context():</span><br><span class="line">    firstTime = time.time()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10000</span>):</span><br><span class="line">        w = Watchlist(title=<span class="string">&#x27;AAA&#x27;</span>, year=i)</span><br><span class="line">        db.session.add(w)</span><br><span class="line">        db.session.commit()</span><br><span class="line">    secondTime = time.time()</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(secondTime-firstTime)</span><br><span class="line"></span><br><span class="line"><span class="comment">#8.015835285186768</span></span><br></pre></td></tr></table></figure>

<p><strong>方法二：</strong>数据插入完后一起 commit() 提交。创建所有对象后，使用 <code>bulk_save_objects()</code> 方法批量保存对象，然后统一提交。但是消耗会更多的内存，因为所有对象都先创建在内存中。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> app.__init__ <span class="keyword">import</span> app, db</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> app.app_context():</span><br><span class="line">    firstTime = time.time()</span><br><span class="line">    db.session.bulk_save_objects(</span><br><span class="line">        [Watchlist(title=<span class="string">&#x27;AAA&#x27;</span>, year=i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10000</span>)]</span><br><span class="line">    )</span><br><span class="line">    db.session.commit()</span><br><span class="line">    secondTime = time.time()</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(secondTime-firstTime)</span><br><span class="line"></span><br><span class="line"><span class="comment">#0.1895279884338379</span></span><br></pre></td></tr></table></figure>

<p><strong>方法三：</strong>使用 <code>bulk_insert_mappings</code>() 方法批量插入。创建字典列表，然后使用 <code>bulk_insert_mappings()</code> 方法进行批量插入。比逐条插入和 <code>bulk_save_objects</code>() 更快，因为它直接操作数据库，不需要创建 SQLAlchemy 对象。<strong>没有缺点，适用于大批量插入。</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> app.__init__ <span class="keyword">import</span> app, db</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> app.app_context():</span><br><span class="line">    firstTime = time.time()</span><br><span class="line">    db.session.bulk_insert_mappings(</span><br><span class="line">        Watchlist,</span><br><span class="line">        [<span class="built_in">dict</span>(title=<span class="string">&#x27;AAA&#x27;</span>, year=i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10000</span>)]</span><br><span class="line">    )</span><br><span class="line">    db.session.commit()</span><br><span class="line">    secondTime = time.time()</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(secondTime-firstTime)</span><br><span class="line"></span><br><span class="line"><span class="comment">#0.12148857116699219</span></span><br></pre></td></tr></table></figure>

<p><strong>方法四：</strong>使用原生 SQL 的 insert 方法批量插入。使用 SQLAlchemy 的 <code>execute</code> 方法执行原生 SQL 插入操作。这是<strong>最快的方法</strong>，因为它直接生成并执行 SQL 插入语句，最大限度地减少了 Python 层面的开销。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> app.__init__ <span class="keyword">import</span> app, db</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> app.app_context():</span><br><span class="line">    firstTime = time.time()</span><br><span class="line">    db.session.execute(</span><br><span class="line">        Watchlist.__table__.insert(),</span><br><span class="line">        [&#123;<span class="string">&#x27;title&#x27;</span>: <span class="string">&#x27;AAA&#x27;</span>, <span class="string">&#x27;year&#x27;</span>: i&#125; <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10000</span>)]</span><br><span class="line">    )</span><br><span class="line">    db.session.commit()</span><br><span class="line">    secondTime = time.time()</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(secondTime-firstTime)</span><br><span class="line"></span><br><span class="line"><span class="comment">#0.07176971435546875</span></span><br></pre></td></tr></table></figure>

<h3 id="连接池"><a href="#连接池" class="headerlink" title="连接池"></a>连接池</h3><p>连接池（Connection Pool）是一种用于管理数据库连接的设计模式，目的是为了提高数据库操作的性能和效率。它通过维护一组数据库连接，减少了每次数据库操作时创建和销毁连接的开销。</p>
<p>连接池是提高数据库访问效率的重要手段。通过预先创建连接并进行复用，可以显著减少连接创建的开销和资源消耗，适用于高并发和对性能要求较高的应用场景。</p>
<h4 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h4><ol>
<li><strong>初始化连接池</strong>：在应用启动时，连接池会预先创建一定数量的数据库连接，并将其放入池中。</li>
<li><strong>获取连接</strong>：当应用需要进行数据库操作时，它从连接池中获取一个可用的连接，而不是每次都创建新连接。</li>
<li><strong>使用连接</strong>：应用执行数据库操作后，使用完的连接不会被关闭，而是返回到连接池中，以便其他请求复用。</li>
<li><strong>释放连接</strong>：连接在被使用后会被释放回连接池，而不是被销毁。连接池可以根据配置自动管理连接的生命周期。</li>
</ol>
<h4 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h4><ul>
<li><strong>性能提升</strong>：重用已有的连接，减少了连接的创建和销毁开销，显著提高了数据库操作的性能。</li>
<li><strong>资源管理</strong>：通过限制连接的数量，可以有效控制数据库资源的使用，避免过多连接导致数据库负载过重。</li>
<li><strong>连接复用</strong>：提高了数据库连接的利用率，减少了连接等待时间。</li>
</ul>
<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> sessionmaker</span><br><span class="line"><span class="keyword">from</span> config <span class="keyword">import</span> DatabaseConfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建数据库引擎，配置连接池</span></span><br><span class="line">engine = create_engine(</span><br><span class="line">    DatabaseConfig.SQLALCHEMY_DATABASE_URI,</span><br><span class="line">    <span class="comment"># 连接池中最多10个连接</span></span><br><span class="line">    pool_size=<span class="number">10</span>,</span><br><span class="line">    <span class="comment"># 连接池满后最多额外创建20个连接</span></span><br><span class="line">    max_overflow=<span class="number">20</span>,</span><br><span class="line">    <span class="comment"># 等待连接的超时时间为30秒</span></span><br><span class="line">    pool_timeout=<span class="number">30</span>,</span><br><span class="line">    <span class="comment"># 连接在池中超过多少秒后会被回收，设置为-1表示禁用连接回收</span></span><br><span class="line">    pool_recycle=-<span class="number">1</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建会话</span></span><br><span class="line">Session = sessionmaker(bind=engine)</span><br><span class="line">session = Session()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">query_users</span>():</span><br><span class="line">    <span class="keyword">with</span> Session() <span class="keyword">as</span> session:</span><br><span class="line">        <span class="comment"># 查询所有用户</span></span><br><span class="line">        users = session.query(User).<span class="built_in">all</span>()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;All users:&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> user <span class="keyword">in</span> users:</span><br><span class="line">            <span class="built_in">print</span>(user)</span><br><span class="line">            </span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">query_users</span>():</span><br><span class="line">    session = Session()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 执行查询</span></span><br><span class="line">        users = session.query(User).<span class="built_in">all</span>()</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        session.close()  <span class="comment"># 确保会话在使用后关闭</span></span><br></pre></td></tr></table></figure>

<h2 id="数据库优化"><a href="#数据库优化" class="headerlink" title="数据库优化"></a>数据库优化</h2><ol>
<li><p>避免 N+1 查询：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 不好的示例  </span></span><br><span class="line"><span class="keyword">for</span> user <span class="keyword">in</span> session.query(User).<span class="built_in">all</span>():  </span><br><span class="line">    <span class="built_in">print</span>(user.name)  </span><br><span class="line">    <span class="built_in">print</span>(user.email)  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># 好的示例  </span></span><br><span class="line">users = session.query(User).<span class="built_in">all</span>()  </span><br><span class="line"><span class="keyword">for</span> user <span class="keyword">in</span> users:  </span><br><span class="line">    <span class="built_in">print</span>(user.name)  </span><br><span class="line">    <span class="built_in">print</span>(user.email)</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用原生 SQL：在需要高性能的部分使用原生 SQL ，如大批量的查询。而在常规的数据操作和开发过程中使用 SQLAlchemy 。</p>
</li>
</ol>
<h2 id="三种方法对比"><a href="#三种方法对比" class="headerlink" title="三种方法对比"></a>三种方法对比</h2><h3 id="Flask-SQLAlchemy"><a href="#Flask-SQLAlchemy" class="headerlink" title="Flask-SQLAlchemy"></a>Flask-SQLAlchemy</h3><h4 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h4><ul>
<li>提供对 SQLAlchemy 的高层封装，便于直接在 Flask 中使用。</li>
<li>内置了Flask 的上下文管理，自动处理请求生命周期中的数据库会话。</li>
<li>提供 ORM 功能，便于对象与关系数据库之间的映射，代码结构更具可读性和可维护性。</li>
</ul>
<h4 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h4><ul>
<li><strong>推荐场景</strong>：适用于大部分需要数据库操作的 Flask 项目，尤其是项目规模较大、需要频繁的增删改查操作时。ORM 便于模型定义和对象操作，对开发效率和代码可读性提升较大。</li>
<li><strong>优势</strong>：结合 Flask 的生命周期管理数据库会话，自动回收资源，降低会话管理的复杂性。</li>
<li><strong>缺点</strong>：对数据库的细粒度控制不如 SQLAlchemy 核心模式（如自定义事务控制），也稍微增加了一些开销。</li>
</ul>
<h3 id="PyMySQL"><a href="#PyMySQL" class="headerlink" title="PyMySQL"></a>PyMySQL</h3><h4 id="特点-1"><a href="#特点-1" class="headerlink" title="特点"></a>特点</h4><ul>
<li>直接连接 MySQL 数据库，不使用 ORM，需要手动编写 SQL 语句。</li>
<li>不依赖 Flask 的上下文管理，代码相对简单，适合对数据库访问需求较少的场景。</li>
</ul>
<h4 id="使用场景-1"><a href="#使用场景-1" class="headerlink" title="使用场景"></a>使用场景</h4><ul>
<li><strong>推荐场景</strong>：适合轻量级的小项目，或仅需少量数据库操作的应用，也适合快速原型开发。</li>
<li><strong>优势</strong>：对于简单的查询操作，代码简洁，直接执行 SQL 语句，不涉及对象映射。</li>
<li><strong>缺点</strong>：不具备 ORM 的抽象性，对复杂数据结构不够友好，可读性较低，容易造成 SQL 注入风险，需要手动管理数据库连接。</li>
</ul>
<h3 id="SQLAlchemy-Core"><a href="#SQLAlchemy-Core" class="headerlink" title="SQLAlchemy Core"></a>SQLAlchemy Core</h3><h4 id="特点-2"><a href="#特点-2" class="headerlink" title="特点"></a>特点</h4><ul>
<li>SQLAlchemy 的原生使用方式，可通过 <code>declarative_base</code> 构建 ORM 模型类，也可以直接使用 SQL 语句执行查询。</li>
<li>支持手动管理会话（Session）生命周期，可以自定义事务和细粒度控制。</li>
<li>不依赖 Flask 的上下文，因此适合在 Flask 之外的独立脚本或异步任务中使用。</li>
</ul>
<h4 id="使用场景-2"><a href="#使用场景-2" class="headerlink" title="使用场景"></a>使用场景</h4><ul>
<li><strong>推荐场景</strong>：适合大型项目或复杂数据库操作的需求，尤其是对会话控制、事务管理有较高要求的应用。也适合在 Flask 以外的其他 Python 应用中使用。</li>
<li><strong>优势</strong>：相比 Flask-SQLAlchemy 更灵活，直接支持原生 SQLAlchemy 的功能（如手动控制事务），适合多线程和异步环境。</li>
<li><strong>缺点</strong>：在 Flask 应用中使用时需要手动管理会话生命周期，可能增加复杂度。</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li><strong>Flask-SQLAlchemy</strong>：适合大部分 Flask 项目，推荐优先选择。简单、集成性强，特别适合开发速度要求高的项目。</li>
<li><strong>PyMySQL</strong>：适合简单需求或快速原型项目，适用范围较窄，缺少 ORM 抽象。</li>
<li><strong>SQLAlchemy Core</strong>：适合需要更多灵活性、复杂性控制的项目，对 Flask 依赖较低，适合大型项目或需要在非 Flask 环境中使用的数据库操作。</li>
</ul>
<h1 id="蓝图"><a href="#蓝图" class="headerlink" title="蓝图"></a>蓝图</h1><p>Flask 的蓝图（Blueprints）是一种组织代码的机制，允许你将 Flask 应用分解成多个模块。这样可以更好地组织应用逻辑，使得应用更具可维护性和可扩展性。</p>
<p>每个蓝图可以有自己的路由、视图函数、模板和静态文件，这样可以将相关的功能分组。</p>
<p>通过使用蓝图，你可以将 Flask 应用拆分成多个模块，每个模块处理相关的功能，使得代码更加清晰和易于管理。</p>
<h2 id="创建蓝图"><a href="#创建蓝图" class="headerlink" title="创建蓝图"></a>创建蓝图</h2><p>创建蓝图涉及到以下几个步骤：</p>
<p><strong>定义蓝图：</strong>在一个独立的模块中定义蓝图。</p>
<p><strong>注册蓝图：</strong>在主应用中注册蓝图，使其生效。</p>
<p>假设我们要创建一个博客应用，其中包含用户管理和博客功能，我们可以将这些功能分成两个蓝图：auth 和 blog。</p>
<p>项目结构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">yourapp/</span><br><span class="line">│</span><br><span class="line">├── app.py</span><br><span class="line">├── auth/</span><br><span class="line">│   ├── __init__.py</span><br><span class="line">│   └── routes.py</span><br><span class="line">│</span><br><span class="line">└── blog/</span><br><span class="line">    ├── __init__.py</span><br><span class="line">    └── routes.py</span><br></pre></td></tr></table></figure>

<h2 id="定义蓝图"><a href="#定义蓝图" class="headerlink" title="定义蓝图"></a>定义蓝图</h2><p>auth&#x2F;routes.py 文件代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint, render_template, request, redirect, url_for</span><br><span class="line"></span><br><span class="line">auth = Blueprint(<span class="string">&#x27;auth&#x27;</span>, __name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@auth.route(<span class="params"><span class="string">&#x27;/login&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;login.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@auth.route(<span class="params"><span class="string">&#x27;/logout&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">logout</span>():</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;auth.login&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="meta">@auth.route(<span class="params"><span class="string">&#x27;/register&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;register.html&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>**Blueprint(‘auth’, <strong>name</strong>)**：创建一个名为 auth 的蓝图。</p>
<p>蓝图中定义的路由函数可以用来处理请求。</p>
<h2 id="注册蓝图"><a href="#注册蓝图" class="headerlink" title="注册蓝图"></a>注册蓝图</h2><p>app.py 文件代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入蓝图</span></span><br><span class="line"><span class="keyword">from</span> auth.routes <span class="keyword">import</span> auth</span><br><span class="line"><span class="keyword">from</span> blog.routes <span class="keyword">import</span> blog</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注册蓝图</span></span><br><span class="line">app.register_blueprint(auth, url_prefix=<span class="string">&#x27;/auth&#x27;</span>)</span><br><span class="line">app.register_blueprint(blog, url_prefix=<span class="string">&#x27;/blog&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p><code>app.register_blueprint(auth, url_prefix=&#39;/auth&#39;)</code>：注册 <code>auth</code> 蓝图，并将所有的路由前缀设置为 <code>/auth</code>。</p>
<h2 id="模板和静态文件"><a href="#模板和静态文件" class="headerlink" title="模板和静态文件"></a>模板和静态文件</h2><p>蓝图中的模板和静态文件应放在蓝图的文件夹下的 templates 和 static 子文件夹中。</p>
<p>项目结构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">yourapp/</span><br><span class="line">│</span><br><span class="line">├── app.py</span><br><span class="line">├── auth/</span><br><span class="line">│   ├── __init__.py</span><br><span class="line">│   ├── routes.py</span><br><span class="line">│   └── templates/</span><br><span class="line">│       ├── login.html</span><br><span class="line">│       └── register.html</span><br><span class="line">│</span><br><span class="line">└── blog/</span><br><span class="line">    ├── __init__.py</span><br><span class="line">    ├── routes.py</span><br><span class="line">    └── templates/</span><br><span class="line">        ├── index.html</span><br><span class="line">        └── post.html</span><br></pre></td></tr></table></figure>

<h2 id="请求钩子"><a href="#请求钩子" class="headerlink" title="请求钩子"></a>请求钩子</h2><p>蓝图支持请求钩子，例如 <strong>before_request</strong> 和 <strong>after_request</strong>，可以在蓝图中定义这些钩子来处理请求和响应。</p>
<p>auth&#x2F;routes.py 文件代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@auth.before_app_request</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">before_request</span>():</span><br><span class="line">    <span class="comment"># 执行在每个请求之前的操作</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@auth.after_app_request</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">after_request</span>(<span class="params">response</span>):</span><br><span class="line">    <span class="comment"># 执行在每个请求之后的操作</span></span><br><span class="line">    <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>

<h2 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h2><p>蓝图也可以定义自己的错误处理函数。</p>
<p>blog&#x2F;routes.py 文件代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@blog.errorhandler(<span class="params"><span class="number">404</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">page_not_found</span>(<span class="params">error</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Page not found&#x27;</span>, <span class="number">404</span></span><br></pre></td></tr></table></figure>

<h1 id="错误处理-1"><a href="#错误处理-1" class="headerlink" title="错误处理"></a>错误处理</h1><h2 id="处理HTTP错误"><a href="#处理HTTP错误" class="headerlink" title="处理HTTP错误"></a>处理HTTP错误</h2><p>Flask 允许你定义针对特定 HTTP 状态码的错误处理函数。这些处理函数可以用于捕获并处理应用中的常见错误，如 404 页面未找到错误、500 服务器内部错误等。</p>
<p>app.py 文件代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Welcome to the homepage!&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.errorhandler(<span class="params"><span class="number">404</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">page_not_found</span>(<span class="params">error</span>):</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;404.html&#x27;</span>), <span class="number">404</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.errorhandler(<span class="params"><span class="number">500</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">internal_server_error</span>(<span class="params">error</span>):</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;500.html&#x27;</span>), <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>**@app.errorhandler(404)**：捕获 404 错误，并返回自定义的 404 错误页面。</p>
<h2 id="蓝图中的错误处理"><a href="#蓝图中的错误处理" class="headerlink" title="蓝图中的错误处理"></a>蓝图中的错误处理</h2><p>蓝图（Blueprints）也可以定义自己的错误处理函数。这使得每个模块可以有自己的错误处理逻辑。</p>
<p>auth&#x2F;routes.py 文件代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint, render_template</span><br><span class="line"></span><br><span class="line">auth = Blueprint(<span class="string">&#x27;auth&#x27;</span>, __name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@auth.errorhandler(<span class="params"><span class="number">404</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">auth_not_found</span>(<span class="params">error</span>):</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;auth_404.html&#x27;</span>), <span class="number">404</span></span><br></pre></td></tr></table></figure>

<h2 id="自定义错误"><a href="#自定义错误" class="headerlink" title="自定义错误"></a>自定义错误</h2><p>在 Flask 中，自定义异常可以帮助你更好地管理应用程序中的错误处理。通过创建自定义异常类，你可以定义特定的错误类型，并在出现错误时返回适当的响应。</p>
<p><strong>步骤：</strong></p>
<ol>
<li>定义自定义异常类：你可以通过继承 Python 的内置异常类（如 <code>Exception</code>）来定义自定义异常。</li>
<li>注册错误处理器：使用 Flask 的 <code>@app.errorhandler</code> 装饰器来注册自定义异常的处理函数。</li>
<li>引发自定义异常：在你的视图函数中，根据需要引发自定义异常。</li>
</ol>
<p><strong>示例：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, jsonify</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 定义自定义异常类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustomError</span>(<span class="title class_ inherited__">Exception</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, message, status_code=<span class="number">400</span></span>):</span><br><span class="line">        self.message = message</span><br><span class="line">        self.status_code = status_code</span><br><span class="line">        <span class="built_in">super</span>().__init__(self.message)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 注册错误处理器</span></span><br><span class="line"><span class="meta">@app.errorhandler(<span class="params">CustomError</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handle_custom_error</span>(<span class="params">error</span>):</span><br><span class="line">    response = jsonify(&#123;<span class="string">&#x27;error&#x27;</span>: error.message&#125;)</span><br><span class="line">    response.status_code = error.status_code</span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 使用自定义异常</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/divide/&lt;int:a&gt;/&lt;int:b&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">divide</span>(<span class="params">a, b</span>):</span><br><span class="line">    <span class="keyword">if</span> b == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">raise</span> CustomError(<span class="string">&quot;Division by zero is not allowed.&quot;</span>, status_code=<span class="number">400</span>)</span><br><span class="line">    result = a / b</span><br><span class="line">    <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;result&#x27;</span>: result&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<h2 id="全局错误处理"><a href="#全局错误处理" class="headerlink" title="全局错误处理"></a>全局错误处理</h2><p>如果你希望在整个应用中处理所有未处理的异常，可以使用全局错误处理函数。这些处理函数可以捕获所有<strong>未被显式捕获</strong>的错误。</p>
<p>app.py 文件代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.errorhandler(<span class="params">Exception</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handle_exception</span>(<span class="params">error</span>):</span><br><span class="line">    <span class="comment"># 处理所有异常</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&#x27;An error occurred: <span class="subst">&#123;error&#125;</span>&#x27;</span>, <span class="number">500</span></span><br></pre></td></tr></table></figure>

<h2 id="使用abort函数"><a href="#使用abort函数" class="headerlink" title="使用abort函数"></a>使用abort函数</h2><p>Flask 提供了一个 abort 函数，用于在视图函数中主动触发 HTTP 错误。这可以用于在特定条件下返回错误响应。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> abort</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/abort_example&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">abort_example</span>():</span><br><span class="line">    abort(<span class="number">403</span>)  <span class="comment"># 返回 403 Forbidden 错误</span></span><br></pre></td></tr></table></figure>

<p>**abort(403)**：触发 403 错误，自动调用对应的错误处理函数。</p>
<h2 id="渲染自定义错误界面"><a href="#渲染自定义错误界面" class="headerlink" title="渲染自定义错误界面"></a>渲染自定义错误界面</h2><p>可以为每个错误码创建自定义的 HTML 页面。</p>
<h1 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h1><p>Flask 的中间件（middleware）是对请求和响应进行处理的钩子，通常用于在请求到达视图函数之前或在响应发送到客户端之前执行一些操作。中间件可以用于日志记录、请求修改、响应修改等。</p>
<h2 id="请求钩子-1"><a href="#请求钩子-1" class="headerlink" title="请求钩子"></a>请求钩子</h2><p>请求钩子允许你在处理请求的不同阶段插入代码，Flask 提供了几种钩子来处理请求生命周期的不同阶段：</p>
<ul>
<li>**<code>before_request</code>**：在每个请求处理之前执行。</li>
<li>**<code>after_request</code>**：在每个请求处理之后执行。</li>
<li>**<code>teardown_request</code>**：请求处理结束后，无论是否发生异常都会执行。</li>
<li>**<code>before_first_request</code>**：仅在应用第一次处理请求之前执行。</li>
</ul>
<h2 id="自定义中间件"><a href="#自定义中间件" class="headerlink" title="自定义中间件"></a>自定义中间件</h2><p>Flask 还允许你创建自定义中间件类，这些中间件类可以在请求和响应处理的各个阶段进行操作。</p>
<p>middleware.py 文件代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CustomMiddleware</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, app</span>):</span><br><span class="line">        self.app = app</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">self, environ, start_response</span>):</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">custom_start_response</span>(<span class="params">status, headers</span>):</span><br><span class="line">            headers.append((<span class="string">&#x27;X-Custom-Header&#x27;</span>, <span class="string">&#x27;Value&#x27;</span>))</span><br><span class="line">            <span class="keyword">return</span> start_response(status, headers)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> self.app(environ, custom_start_response)</span><br></pre></td></tr></table></figure>

<p>app.py 文件代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> middleware <span class="keyword">import</span> CustomMiddleware</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">app.wsgi_app = CustomMiddleware(app.wsgi_app)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello, World!&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

</article><div class="tag_share"><div class="post_share"></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83"><span class="toc-number">2.</span> <span class="toc-text">虚拟环境</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA"><span class="toc-number">2.1.</span> <span class="toc-text">创建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BF%80%E6%B4%BB"><span class="toc-number">2.2.</span> <span class="toc-text">激活</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%BA%94%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text">第一个应用</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="toc-number">4.</span> <span class="toc-text">项目结构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E9%A1%B9%E7%9B%AE"><span class="toc-number">4.1.</span> <span class="toc-text">简单项目</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%AD%E5%9E%8B%E9%A1%B9%E7%9B%AE"><span class="toc-number">4.2.</span> <span class="toc-text">中型项目</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%8D%E6%9D%82%E9%A1%B9%E7%9B%AE"><span class="toc-number">4.3.</span> <span class="toc-text">复杂项目</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1"><span class="toc-number">5.</span> <span class="toc-text">路由</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E8%B7%AF%E7%94%B1"><span class="toc-number">5.1.</span> <span class="toc-text">定义路由</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E5%8F%82%E6%95%B0"><span class="toc-number">5.2.</span> <span class="toc-text">路由参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E8%A7%84%E5%88%99"><span class="toc-number">5.3.</span> <span class="toc-text">路由规则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E6%96%B9%E6%B3%95"><span class="toc-number">5.4.</span> <span class="toc-text">请求方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E8%BD%AC%E6%8D%A2%E5%99%A8"><span class="toc-number">5.5.</span> <span class="toc-text">路由转换器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E5%87%BD%E6%95%B0%E8%BF%94%E5%9B%9E"><span class="toc-number">5.6.</span> <span class="toc-text">路由函数返回</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6%E5%92%8C%E6%A8%A1%E6%9D%BF"><span class="toc-number">5.7.</span> <span class="toc-text">静态文件和模板</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E4%BC%98%E5%85%88%E7%BA%A7"><span class="toc-number">5.8.</span> <span class="toc-text">路由优先级</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%A7%86%E5%9B%BE%E5%87%BD%E6%95%B0"><span class="toc-number">6.</span> <span class="toc-text">视图函数</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E8%A7%86%E5%9B%BE%E5%87%BD%E6%95%B0"><span class="toc-number">6.1.</span> <span class="toc-text">定义视图函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A5%E6%94%B6%E8%AF%B7%E6%B1%82%E6%95%B0%E6%8D%AE"><span class="toc-number">6.2.</span> <span class="toc-text">接收请求数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%94%E5%9B%9E%E5%93%8D%E5%BA%94"><span class="toc-number">6.3.</span> <span class="toc-text">返回响应</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82%E5%92%8C%E5%93%8D%E5%BA%94"><span class="toc-number">6.4.</span> <span class="toc-text">处理请求和响应</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E9%94%99%E8%AF%AF"><span class="toc-number">6.5.</span> <span class="toc-text">处理错误</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%86%E5%9B%BE%E5%87%BD%E6%95%B0%E7%9A%84%E8%A3%85%E9%A5%B0%E5%99%A8"><span class="toc-number">6.6.</span> <span class="toc-text">视图函数的装饰器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%86%E5%9B%BE%E5%87%BD%E6%95%B0%E8%BF%94%E5%9B%9E%E7%8A%B6%E6%80%81%E7%A0%81"><span class="toc-number">6.7.</span> <span class="toc-text">视图函数返回状态码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E4%B8%AA%E6%A0%87%E5%87%86%E7%9A%84%E8%A7%86%E5%9B%BE%E5%87%BD%E6%95%B0"><span class="toc-number">6.8.</span> <span class="toc-text">一个标准的视图函数</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A8%A1%E6%9D%BF%E6%B8%B2%E6%9F%93"><span class="toc-number">7.</span> <span class="toc-text">模板渲染</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%A1%A8%E5%8D%95%E5%A4%84%E7%90%86"><span class="toc-number">8.</span> <span class="toc-text">表单处理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E8%A1%A8%E5%8D%95%E5%A4%84%E7%90%86"><span class="toc-number">8.1.</span> <span class="toc-text">基本表单处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Flask-WTF%E6%89%A9%E5%B1%95"><span class="toc-number">8.2.</span> <span class="toc-text">使用Flask-WTF扩展</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%A8%E5%8D%95%E9%AA%8C%E8%AF%81"><span class="toc-number">8.3.</span> <span class="toc-text">表单验证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">8.4.</span> <span class="toc-text">文件上传</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CSRF%E4%BF%9D%E6%8A%A4"><span class="toc-number">8.5.</span> <span class="toc-text">CSRF保护</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C"><span class="toc-number">9.</span> <span class="toc-text">数据库操作</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Flask-SQLAlchemy"><span class="toc-number">9.1.</span> <span class="toc-text">使用Flask-SQLAlchemy</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AESQLAlchemy"><span class="toc-number">9.1.1.</span> <span class="toc-text">配置SQLAlchemy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E6%A8%A1%E5%9E%8B"><span class="toc-number">9.1.2.</span> <span class="toc-text">定义模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E8%A1%A8"><span class="toc-number">9.1.3.</span> <span class="toc-text">创建数据表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E7%9A%84CRUD%E6%93%8D%E4%BD%9C"><span class="toc-number">9.1.4.</span> <span class="toc-text">基本的CRUD操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%AE%B0%E5%BD%95"><span class="toc-number">9.1.4.1.</span> <span class="toc-text">创建记录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96%E8%AE%B0%E5%BD%95"><span class="toc-number">9.1.4.2.</span> <span class="toc-text">读取记录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E8%AE%B0%E5%BD%95"><span class="toc-number">9.1.4.3.</span> <span class="toc-text">更新记录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E8%AE%B0%E5%BD%95"><span class="toc-number">9.1.4.4.</span> <span class="toc-text">删除记录</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%93%8D%E4%BD%9C"><span class="toc-number">9.1.5.</span> <span class="toc-text">查询操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2"><span class="toc-number">9.1.5.1.</span> <span class="toc-text">基本查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%8D%E6%9D%82%E6%9F%A5%E8%AF%A2"><span class="toc-number">9.1.5.2.</span> <span class="toc-text">复杂查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%92%E5%BA%8F%E5%92%8C%E5%88%86%E9%A1%B5"><span class="toc-number">9.1.5.3.</span> <span class="toc-text">排序和分页</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%94%9FSQL"><span class="toc-number">9.1.6.</span> <span class="toc-text">原生SQL</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8PyMySQL"><span class="toc-number">9.2.</span> <span class="toc-text">使用PyMySQL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8SQLAlchemy%E6%A0%B8%E5%BF%83%E6%A8%A1%E5%9D%97"><span class="toc-number">9.3.</span> <span class="toc-text">使用SQLAlchemy核心模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E9%85%8D%E7%BD%AE"><span class="toc-number">9.3.1.</span> <span class="toc-text">初始化配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">9.3.2.</span> <span class="toc-text">连接数据库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%A0%E5%B0%84%E8%AF%B4%E6%98%8E"><span class="toc-number">9.3.3.</span> <span class="toc-text">映射说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%B1%BB"><span class="toc-number">9.3.4.</span> <span class="toc-text">创建类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%BC%9A%E8%AF%9D"><span class="toc-number">9.3.5.</span> <span class="toc-text">创建会话</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A2%9E%E5%8A%A0"><span class="toc-number">9.3.6.</span> <span class="toc-text">增加</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2"><span class="toc-number">9.3.7.</span> <span class="toc-text">查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E7%AD%9B%E9%80%89"><span class="toc-number">9.3.8.</span> <span class="toc-text">条件筛选</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0"><span class="toc-number">9.3.9.</span> <span class="toc-text">更新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4"><span class="toc-number">9.3.10.</span> <span class="toc-text">删除</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%94%9FSQL-1"><span class="toc-number">9.3.11.</span> <span class="toc-text">原生SQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%B9%E9%87%8F%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE"><span class="toc-number">9.3.12.</span> <span class="toc-text">批量插入数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E6%B1%A0"><span class="toc-number">9.3.13.</span> <span class="toc-text">连接池</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">9.3.13.1.</span> <span class="toc-text">工作原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%98%E7%82%B9"><span class="toc-number">9.3.13.2.</span> <span class="toc-text">优点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE"><span class="toc-number">9.3.13.3.</span> <span class="toc-text">配置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BC%98%E5%8C%96"><span class="toc-number">9.4.</span> <span class="toc-text">数据库优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E7%A7%8D%E6%96%B9%E6%B3%95%E5%AF%B9%E6%AF%94"><span class="toc-number">9.5.</span> <span class="toc-text">三种方法对比</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Flask-SQLAlchemy"><span class="toc-number">9.5.1.</span> <span class="toc-text">Flask-SQLAlchemy</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%B9%E7%82%B9"><span class="toc-number">9.5.1.1.</span> <span class="toc-text">特点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">9.5.1.2.</span> <span class="toc-text">使用场景</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PyMySQL"><span class="toc-number">9.5.2.</span> <span class="toc-text">PyMySQL</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%B9%E7%82%B9-1"><span class="toc-number">9.5.2.1.</span> <span class="toc-text">特点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF-1"><span class="toc-number">9.5.2.2.</span> <span class="toc-text">使用场景</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SQLAlchemy-Core"><span class="toc-number">9.5.3.</span> <span class="toc-text">SQLAlchemy Core</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%B9%E7%82%B9-2"><span class="toc-number">9.5.3.1.</span> <span class="toc-text">特点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF-2"><span class="toc-number">9.5.3.2.</span> <span class="toc-text">使用场景</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">9.5.4.</span> <span class="toc-text">总结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%93%9D%E5%9B%BE"><span class="toc-number">10.</span> <span class="toc-text">蓝图</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%93%9D%E5%9B%BE"><span class="toc-number">10.1.</span> <span class="toc-text">创建蓝图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E8%93%9D%E5%9B%BE"><span class="toc-number">10.2.</span> <span class="toc-text">定义蓝图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E8%93%9D%E5%9B%BE"><span class="toc-number">10.3.</span> <span class="toc-text">注册蓝图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E6%9D%BF%E5%92%8C%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6"><span class="toc-number">10.4.</span> <span class="toc-text">模板和静态文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E9%92%A9%E5%AD%90"><span class="toc-number">10.5.</span> <span class="toc-text">请求钩子</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="toc-number">10.6.</span> <span class="toc-text">错误处理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86-1"><span class="toc-number">11.</span> <span class="toc-text">错误处理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%84%E7%90%86HTTP%E9%94%99%E8%AF%AF"><span class="toc-number">11.1.</span> <span class="toc-text">处理HTTP错误</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%93%9D%E5%9B%BE%E4%B8%AD%E7%9A%84%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="toc-number">11.2.</span> <span class="toc-text">蓝图中的错误处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%94%99%E8%AF%AF"><span class="toc-number">11.3.</span> <span class="toc-text">自定义错误</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="toc-number">11.4.</span> <span class="toc-text">全局错误处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8abort%E5%87%BD%E6%95%B0"><span class="toc-number">11.5.</span> <span class="toc-text">使用abort函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B8%B2%E6%9F%93%E8%87%AA%E5%AE%9A%E4%B9%89%E9%94%99%E8%AF%AF%E7%95%8C%E9%9D%A2"><span class="toc-number">11.6.</span> <span class="toc-text">渲染自定义错误界面</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">12.</span> <span class="toc-text">中间件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E9%92%A9%E5%AD%90-1"><span class="toc-number">12.1.</span> <span class="toc-text">请求钩子</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">12.2.</span> <span class="toc-text">自定义中间件</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background: transparent"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2024 By Emily</div><div class="footer_custom_text">To be continued.</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script src="/js/yituliu.js"></script><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>